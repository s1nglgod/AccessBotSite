<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Сервер Токенов с Админ Панелью</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
    }
    .admin-panel {
      margin-right: 20px;
    }
    input {
      margin-right: 10px;
    }
    .token-list {
      border: 1px solid #ccc;
      width: 30vw;
      height: 90vh;
      overflow-y: auto;
    }
  </style>
  <script src="js-yaml.min.js"></script>
  <script>
    (function () {
      'use strict';

      let tokenState = {};
      let allTokens = [];
      const repoOwner = 's1nglgod'; 
      const repoName = 'AccessBotSite'; 
      const filePath = 'config.yaml'; 
      const accessToken = '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';

      function loadTokenState() {
        fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
          headers: {
            'Authorization': `token ${accessToken}`
          }
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Сеть не в порядке: ' + response.statusText);
            }
            return response.json();
          })
          .then(data => {
            const content = atob(data.content);
            tokenState = jsyaml.load(content);
            allTokens = Object.keys(tokenState);
            updateTokenList();
          })
          .catch(error => console.error('Ошибка при загрузке токенов:', error));
      }

      function saveTokenState() {
        const yamlContent = jsyaml.dump(tokenState);
        const encodedContent = btoa(yamlContent); 

        fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Обновление состояния токенов',
            content: encodedContent,
            sha: '' 
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Ошибка при сохранении токенов: ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          console.log('Состояние токенов успешно сохранено:', data);
        })
        .catch(error => console.error('Ошибка при сохранении токенов:', error));
      }

      function getFreeToken() {
        for (const t of allTokens) {
          if (!tokenState[t]) {
            tokenState[t] = true; 
            saveTokenState(); 
            return t;
          }
        }
        return null;
      }

      function freeToken(token) {
        if (!(token in tokenState)) return false;
        if (!tokenState[token]) return false; 
        tokenState[token] = false;
        saveTokenState(); 
        return true;
      }

      function addToken(newToken) {
        if (typeof tokenState !== 'object' || tokenState === null) {
          console.error('Ошибка: tokenState не инициализирован.');
          return 'Ошибка: состояние токенов не инициализировано.';
        }

        if (newToken && !tokenState[newToken]) {
          tokenState[newToken] = false; 
          saveTokenState(); 
          return `Токен "${newToken}" успешно добавлен.`;
        } else if (tokenState[newToken]) {
          return `Ошибка: Токен "${newToken}" уже существует.`;
        } else {
          return 'Ошибка: Не указан токен для добавления.';
        }
      }

      function updateTokenList() {
        const tokenList = document.getElementById('tokenList');
        tokenList.innerHTML = ''; 
        for (const token in tokenState) {
          const status = tokenState[token] ? 'Занят' : 'Свободен';
          const listItem = document.createElement('div');
          listItem.textContent = `${token}: ${status}`;
          tokenList.appendChild(listItem);
        }
      }

      function removeAllTokens() {
        tokenState = {}; 
        saveTokenState();
        return 'Все токены успешно удалены.';
      }

      function removeToken(token) {
        if (token in tokenState) {
          delete tokenState[token];
          saveTokenState(); 
          return `Токен "${token}" успешно удален.`;
        } else {
          return `Ошибка: Токен "${token}" не найден.`;
        }
      }

      function occupyToken(token) {
        if (!(token in tokenState)) return false;
        if (tokenState[token]) return false; 
        tokenState[token] = true; 
        saveTokenState(); 
        return true;
      }

      function freeAllTokens() {
        for (const token in tokenState) {
          tokenState[token] = false; 
        }
        saveTokenState();
        return 'Все токены успешно освобождены.';
      }

      function main() {
        loadTokenState();

        const hash = window.location.hash || '#/';
        if (hash === '#/' || hash === '') {
          const token = getFreeToken();
          if (token) {
            document.body.innerHTML = `${token}`;
          } else {
            document.body.textContent = 'Нет свободных токенов.';
          }
        } else if (hash.startsWith('#close/')) {
          const token = decodeURIComponent(hash.slice('#close/'.length));
          if (!token) {
            document.body.textContent = 'Ошибка: не указан токен для освобождения.';
          } else {
            const success = freeToken(token);
            if (success) {
              document.body.textContent = `Токен "${token}" успешно освобожден.`;
            } else {
              document.body.textContent = `Токен "${token}" не найден или уже свободен.`;
            }
          }
        } else if (hash === '#/admin') {
          displayAdminPanel();
        } else {
          document.body.textContent = '404 Не найдено. Используйте "#/" для получения токена, "#close/ТОКЕН" для освобождения токена или "#/admin" для доступа к админ-панели.';
        }
      }

      function displayAdminPanel() {
        document.body.innerHTML = `
          <div class="admin-panel">
            <h1>Админ Панель Токенов</h1>
            <input type="text" id="tokenInput" placeholder="Введите токен" />
            <button id="addButton">Добавить</button>
            <button id="removeButton">Удалить</button>
            <button id="removeAllButton">Удалить все</button>
            <button id="freeButton">Освободить токен</button>
            <button id="occupyButton">Занять токен</button>
            <button id="freeAllButton">Освободить все</button>
            <p id="message"></p>
          </div>
          <div class="token-list" id="tokenList"></div>
        `;

        updateTokenList();

        document.getElementById('addButton').onclick = function() {
          const newToken = document.getElementById('tokenInput').value.trim();
          const message = addToken(newToken);
          document.getElementById('message').textContent = message;
          updateTokenList();
        };

        document.getElementById('freeButton').onclick = function() {
          const tokenToFree = document.getElementById('tokenInput').value.trim();
          const message = freeToken(tokenToFree) ? `Токен "${tokenToFree}" успешно освобожден.` : `Ошибка: Токен "${tokenToFree}" не найден или уже свободен.`;
          document.getElementById('message').textContent = message;
          updateTokenList();
        };

        document.getElementById('removeAllButton').onclick = function() {
          const message = removeAllTokens();
          document.getElementById('message').textContent = message;
          updateTokenList();
        };

        document.getElementById('removeButton').onclick = function() {
          const tokenToRemove = document.getElementById('tokenInput').value.trim();
          const message = removeToken(tokenToRemove);
          document.getElementById('message').textContent = message;
          updateTokenList();
        };

        document.getElementById('freeAllButton').onclick = function() {
          const message = freeAllTokens();
          document.getElementById('message').textContent = message;
          updateTokenList();
        };

        document.getElementById('occupyButton').onclick = function() {
          const tokenToOccupy = document.getElementById('tokenInput').value.trim();
          const success = occupyToken(tokenToOccupy);
          const message = success ? `Токен "${tokenToOccupy}" успешно занят.` : `Ошибка: Токен "${tokenToOccupy}" не найден или уже занят.`;
          document.body.textContent = message;
          updateTokenList(); 
        };
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', main);
      } else {
        main();
      }
    })();
  </script>
</head>
<body>
</body>
</html>
